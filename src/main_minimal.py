"""
Version minimale de main.py pour diagnostiquer les probl√®mes de d√©marrage
Cette version d√©sactive toutes les fonctionnalit√©s non essentielles
"""
import os
from flask import Flask, jsonify
from flask_migrate import Migrate
from flask_jwt_extended import JWTManager

# Importations de base uniquement
from .config import DevelopmentConfig, ProductionConfig
from .models.database import db
from .models.user import User, UserRole
from werkzeug.security import generate_password_hash

# Configuration des environnements
config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'default': DevelopmentConfig
}

def create_app(config_name=None):
    """
    Factory minimaliste pour cr√©er l'application Flask
    Version de diagnostic - fonctionnalit√©s limit√©es
    """
    
    # D√©terminer la configuration
    if config_name is None:
        config_name = os.environ.get('FLASK_ENV', 'development')
    
    print(f"üöÄ D√©marrage en mode MINIMAL - Config: {config_name}")
    
    # Cr√©er l'instance Flask
    app = Flask(__name__)
    
    # Charger la configuration
    app.config.from_object(config[config_name])
    
    # Configuration UTF-8
    app.config['JSON_AS_ASCII'] = False
    app.config['JSON_SORT_KEYS'] = False
    
    # Configuration de la base de donn√©es
    if config_name != 'testing':
        app.config['SQLALCHEMY_DATABASE_URI'] = config[config_name].get_database_uri()
    
    # Initialisation des extensions de base
    db.init_app(app)
    migrate = Migrate(app, db)
    jwt = JWTManager(app)
    
    print("‚úÖ Extensions de base initialis√©es")
    
    # CORS simplifi√©
    @app.after_request
    def add_cors_headers(response):
        """Headers CORS simples"""
        response.headers['Access-Control-Allow-Origin'] = '*'
        response.headers['Access-Control-Allow-Methods'] = 'GET, POST, PUT, DELETE, OPTIONS'
        response.headers['Access-Control-Allow-Headers'] = 'Content-Type, Authorization'
        return response
    
    @app.before_request
    def handle_preflight():
        """Handle OPTIONS requests"""
        from flask import request
        if request.method == 'OPTIONS':
            response = app.make_response(('', 204))
            response.headers['Access-Control-Allow-Origin'] = '*'
            response.headers['Access-Control-Allow-Methods'] = 'GET, POST, PUT, DELETE, OPTIONS'
            response.headers['Access-Control-Allow-Headers'] = 'Content-Type, Authorization'
            return response
    
    print("‚úÖ CORS configur√©")
    
    # AUCUN Blueprint pour l'instant - version ultra-minimale
    print("‚ö†Ô∏è  Aucun blueprint charg√© (mode ultra-minimal)")
    
    # Routes de base
    @app.route('/api/health')
    def health_check():
        """Point de contr√¥le de sant√©"""
        return {
            'status': 'OK',
            'message': 'Spovio API is running (MINIMAL MODE)',
            'environment': config_name,
            'mode': 'minimal'
        }
    
    @app.route('/')
    def index():
        """Page d'accueil"""
        return {
            'message': 'Bienvenue sur l\'API Spovio (Mode Minimal)',
            'version': '1.0.0-minimal',
            'mode': 'diagnostic',
            'endpoints': {
                'health': '/api/health',
                'auth': '/api/auth',
                'admin': '/api/admin'
            }
        }
    
    # Initialisation de la base de donn√©es en d√©veloppement
    if config_name == 'development':
        with app.app_context():
            try:
                db.create_all()
                _create_default_admin(app)
                print("‚úÖ Base de donn√©es initialis√©e")
            except Exception as e:
                print(f"‚ö†Ô∏è Erreur init DB: {e}")
    
    print("üéâ Application cr√©√©e avec succ√®s (MODE MINIMAL)")
    return app

def _create_default_admin(app):
    """Cr√©e l'admin par d√©faut si n√©cessaire"""
    try:
        admin_email = app.config.get('DEFAULT_ADMIN_EMAIL', 'admin@spovio.net')
        super_admin = User.query.filter_by(email=admin_email).first()
        
        if not super_admin:
            super_admin = User(
                email=admin_email,
                password_hash=generate_password_hash(app.config.get('DEFAULT_ADMIN_PASSWORD', 'admin123')),
                name=app.config.get('DEFAULT_ADMIN_NAME', 'Super Admin'),
                role=UserRole.SUPER_ADMIN,
                credits_balance=10000
            )
            db.session.add(super_admin)
            db.session.commit()
            print(f"‚úÖ Super admin cr√©√©: {admin_email}")
        else:
            print(f"‚ÑπÔ∏è  Super admin existe: {admin_email}")
    except Exception as e:
        print(f"‚ö†Ô∏è Erreur cr√©ation admin: {e}")
        db.session.rollback()
